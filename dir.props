<Project ToolsVersion="12.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!--
    $(OS) is set to Unix/Windows_NT. This comes from an environment variable on Windows and MSBuild on Unix.
  -->
  <PropertyGroup>
    <OsEnvironment Condition="'$(OsEnvironment)'==''">$(OS)</OsEnvironment>
  </PropertyGroup>

  <PropertyGroup>
    <TargetFrameworkVersion>v4.5.1</TargetFrameworkVersion>
    <!-- This is to workaround an issue with a dependent assembly (Microsoft.Build.Tasks.CodeAnalysis.dll)
         copying its dependencies (which are in the GAC). -->
    <DoNotCopyLocalIfInGac>true</DoNotCopyLocalIfInGac>
  </PropertyGroup>

   <!-- Compiler config -->
   <PropertyGroup>
     <UseRoslynCompilers>true</UseRoslynCompilers>
     <DebugSymbols Condition="'$(UseRoslynCompilers)' == 'true'">false</DebugSymbols>
  </PropertyGroup>

   <!-- Common repo directories -->
  <PropertyGroup>
    <BuildToolsVersion>1.0.25-prerelease-00080</BuildToolsVersion>
    <CompilerToolsVersion>1.0.0</CompilerToolsVersion>
    <NuSpecReferenceGeneratorVersion>1.3.1</NuSpecReferenceGeneratorVersion>
    <XunitVersion>2.1.0-rc1-build3168</XunitVersion>
    <RepoRoot>$(MSBuildThisFileDirectory)</RepoRoot>
    <SourceDir>$(RepoRoot)src$([System.IO.Path]::DirectorySeparatorChar)</SourceDir>

    <!-- Output directories -->
    <BinDir>$(RepoRoot)bin$([System.IO.Path]::DirectorySeparatorChar)</BinDir>
    <TestWorkingDir>$(BinDir)tests$([System.IO.Path]::DirectorySeparatorChar)</TestWorkingDir>

    <!-- Input Directories -->
    <PackagesDir>$(RepoRoot)packages$([System.IO.Path]::DirectorySeparatorChar)</PackagesDir>
    <ToolsDir>$([System.IO.Path]::Combine($(PackagesDir)Microsoft.DotNet.BuildTools.$(BuildToolsVersion),"lib"))$([System.IO.Path]::DirectorySeparatorChar)</ToolsDir>
    <CompilerToolsDir>$([System.IO.Path]::Combine($(PackagesDir)Microsoft.Net.Compilers.$(CompilerToolsVersion),"tools"))$([System.IO.Path]::DirectorySeparatorChar)</CompilerToolsDir>
    <NuSpecReferenceGeneratorDir>$([System.IO.Path]::Combine($(PackagesDir)NuSpec.ReferenceGenerator.$(NuSpecReferenceGeneratorVersion),"build", "dotnet"))$([System.IO.Path]::DirectorySeparatorChar)</NuSpecReferenceGeneratorDir>

    <!-- NuSpec.ReferenceGenerator targets use SolutionDir -->
    <SolutionDir>$(SourceDir)</SolutionDir>

    <BootstrapDestination>$(BinDir)Bootstrap$([System.IO.Path]::DirectorySeparatorChar)</BootstrapDestination>
  </PropertyGroup>

  <!-- If we're building with a bootstrapped MSBuild, use fresh extensions instead of the installed ones. -->
  <PropertyGroup Condition="'$(BootstrappedMSBuild)' == 'true'">
    <MSBuildExtensionsPath>$(BootstrapDestination)</MSBuildExtensionsPath>
  </PropertyGroup>


  <!-- Common nuget properties -->
  <PropertyGroup>
    <NuGetDir>$(PackagesDir)</NuGetDir>
    <NuGetToolPath Condition="'$(NuGetToolPath)'==''">$(PackagesDir)NuGet.exe</NuGetToolPath>
    <NuGetConfigFile>$([System.IO.Path]::Combine($(SourceDir),".nuget","NuGet.Config"))</NuGetConfigFile>
    <NuGetConfigCommandLine>-ConfigFile "$(NuGetConfigFile)"</NuGetConfigCommandLine>

    <NugetRestoreCommand>"$(NuGetToolPath)"</NugetRestoreCommand>
    <NugetRestoreCommand>$(NugetRestoreCommand) install</NugetRestoreCommand>
    <!-- NuGet.exe doesn't like trailing slashes in the output directory argument -->
    <NugetRestoreCommand>$(NugetRestoreCommand) -OutputDirectory "$(PackagesDir.TrimEnd('/\'.ToCharArray()))"</NugetRestoreCommand>
    <NugetRestoreCommand>$(NugetRestoreCommand) $(NuGetConfigCommandLine)</NugetRestoreCommand>
    <NugetRestoreCommand>$(NugetRestoreCommand) -Verbosity detailed</NugetRestoreCommand>
    <NugetRestoreCommand Condition="'$(OsEnvironment)'=='Unix'">mono $(NuGetRestoreCommand)</NugetRestoreCommand>
    <ProjectPackagesConfigFile>$(NuGetConfigFile)</ProjectPackagesConfigFile>
  </PropertyGroup>

  <!-- Copy the "_._" file to the output directory, which is used by the NuSpecs to indicate an empty folder -->
  <ItemGroup>
    <None Include="$(SourceDir)\nuget\_._">
      <Link>_._</Link>
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Visible>False</Visible>
    </None>
  </ItemGroup>

  <!-- Set default Configuration and Platform -->
  <PropertyGroup>
    <Configuration Condition="'$(Configuration)' ==''">Debug</Configuration>
    <Platform Condition="'$(Platform)'==''">AnyCPU</Platform>
  </PropertyGroup>

  <!-- Setup Default symbol and optimization for Configuration -->
  <PropertyGroup Condition="'$(Configuration)' == 'Debug'">
    <DebugSymbols Condition="'$(DebugSymbols)' == ''">true</DebugSymbols>
    <Optimize Condition="'$(Optimize)' == ''">false</Optimize>
    <DebugType Condition="'$(DebugType)' == ''">full</DebugType>
    <MsbuildDebugger>true</MsbuildDebugger>
    <DefineConstants>$(DefineConstants);DEBUG;TRACE;STANDALONEBUILD</DefineConstants>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)' == 'Debug-MONO'">
    <DebugSymbols Condition="'$(DebugSymbols)' == ''">true</DebugSymbols>
    <Optimize Condition="'$(Optimize)' == ''">false</Optimize>
    <DebugType Condition="'$(DebugType)' == ''">full</DebugType>
    <DefineConstants>$(DefineConstants);DEBUG;TRACE;STANDALONEBUILD;MONO</DefineConstants>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)' == 'Release'">
    <DebugSymbols Condition="'$(DebugSymbols)' == ''">true</DebugSymbols>
    <Optimize Condition="'$(Optimize)' == ''">true</Optimize>
    <DebugType Condition="'$(DebugType)' == ''">pdbonly</DebugType>
    <MsbuildDebugger>true</MsbuildDebugger>
    <DefineConstants>$(DefineConstants);TRACE;STANDALONEBUILD</DefineConstants>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)' == 'Release-MONO'">
    <DebugSymbols Condition="'$(DebugSymbols)' == ''">true</DebugSymbols>
    <Optimize Condition="'$(Optimize)' == ''">true</Optimize>
    <DebugType Condition="'$(DebugType)' == ''">pdbonly</DebugType>
    <DefineConstants>$(DefineConstants);TRACE;STANDALONEBUILD;MONO</DefineConstants>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)' == 'Debug-NetCore'">
    <DebugSymbols Condition="'$(DebugSymbols)' == ''">true</DebugSymbols>
    <Optimize Condition="'$(Optimize)' == ''">false</Optimize>
    <DebugType Condition="'$(DebugType)' == ''">full</DebugType>
    <DefineConstants>$(DefineConstants);DEBUG;TRACE;STANDALONEBUILD</DefineConstants>
    <NetCoreBuild>true</NetCoreBuild>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)' == 'Release-NetCore'">
    <DebugSymbols Condition="'$(DebugSymbols)' == ''">true</DebugSymbols>
    <Optimize Condition="'$(Optimize)' == ''">true</Optimize>
    <DebugType Condition="'$(DebugType)' == ''">pdbonly</DebugType>
    <DefineConstants>$(DefineConstants);TRACE;STANDALONEBUILD</DefineConstants>
    <NetCoreBuild>true</NetCoreBuild>
  </PropertyGroup>

  <PropertyGroup Condition="'$(OS)' != 'Windows_NT'">
    <DebugType/>
    <DebugSymbols>false</DebugSymbols>
    <TargetPlatformIdentifier>$(OS)</TargetPlatformIdentifier>
  </PropertyGroup>

  <!-- This configuration builds against the full .NET Framework but with the compilation constants to compile against
        the .NET Core surface area.  This way we can build a binary to run ApiPort on to measure progress. -->
  <PropertyGroup Condition="'$(Configuration)' == 'Port-Progress'">
    <DebugSymbols Condition="'$(DebugSymbols)' == ''">true</DebugSymbols>
    <Optimize Condition="'$(Optimize)' == ''">false</Optimize>
    <DebugType Condition="'$(DebugType)' == ''">full</DebugType>
    <DefineConstants>$(DefineConstants);DEBUG;TRACE;STANDALONEBUILD</DefineConstants>
    <NetCoreSurface>true</NetCoreSurface>
    <TargetFrameworkVersion>v4.6</TargetFrameworkVersion>
  </PropertyGroup>

  <!-- .NET Core build support -->
  <PropertyGroup Condition="'$(NetCoreBuild)' != 'true'">
    <TargetFrameworkVersion Condition="'$(TargetFrameworkVersion)' == ''">v4.5.1</TargetFrameworkVersion>
    <PlatformTarget>x86</PlatformTarget>
    <BaseNuGetRuntimeIdentifier>win7</BaseNuGetRuntimeIdentifier>
  </PropertyGroup>
  <PropertyGroup Condition="'$(NetCoreBuild)' == 'true'">
    <TargetFrameworkVersion>v5.0</TargetFrameworkVersion>
    <PlatformTarget>x86</PlatformTarget>
    <NuGetTargetMoniker>DNXCore,Version=v5.0</NuGetTargetMoniker>
    <BaseNuGetRuntimeIdentifier>win7</BaseNuGetRuntimeIdentifier>
    <NetCoreSurface>true</NetCoreSurface>
  </PropertyGroup>

  <PropertyGroup Condition="'$(NetCoreSurface)' != 'true'">
    <DefineConstants>$(DefineConstants);FEATURE_APARTMENT_STATE</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_APM</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_APPDOMAIN</DefineConstants>
    <FeatureAppDomain>true</FeatureAppDomain>
    <DefineConstants>$(DefineConstants);FEATURE_APPDOMAIN_UNHANDLED_EXCEPTION</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_ASSEMBLY_LOADFROM</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_ASSEMBLY_LOCATION</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_ASSEMBLYNAME_CULTUREINFO</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_ASSEMBLYNAME_CLONE</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_BINARY_SERIALIZATION</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_COM_INTEROP</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_CONSOLE_BUFFERWIDTH</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_CONSTRAINED_EXECUTION</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_CHARSET_AUTO</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_CODEDOM</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_CULTUREINFO_CONSOLE_FALLBACK</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_CULTUREINFO_GETCULTURES</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_DOTNETVERSION</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_ENCODING_DEFAULT</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_ENVIRONMENT_SYSTEMDIRECTORY</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_FILE_TRACKER</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_GAC</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_GET_COMMANDLINE</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_HANDLE_SAFEWAITHANDLE</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_HANDLEPROCESSCORRUPTEDSTATEEXCEPTIONS</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_HANDLEREF</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_HTTP_LISTENER</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_MEMORYSTREAM_GETBUFFER</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_OSVERSION</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_PARALLEL_BUILD</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_PERFORMANCE_COUNTERS</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_REFLECTION_EMIT_DEBUG_INFO</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_REGISTRY_TOOLSETS</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_REGISTRYHIVE_DYNDATA</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_RESOURCE_EXPOSURE</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_SECURITY_PERMISSIONS</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_SECURITY_PRINCIPAL_WINDOWS</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_SPECIAL_FOLDERS</DefineConstants>
    <FeatureSpecialFolders>true</FeatureSpecialFolders>
    <DefineConstants>$(DefineConstants);FEATURE_STRING_INTERN</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_STRONG_NAMES</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_SYSTEM_CONFIGURATION</DefineConstants>
    <FeatureSystemConfiguration>true</FeatureSystemConfiguration>
    <DefineConstants>$(DefineConstants);FEATURE_THREAD_ABORT</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_THREAD_CULTURE</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_THREAD_PRIORITY</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_TYPE_INVOKEMEMBER</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_TYPE_GETINTERFACE</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_VARIOUS_EXCEPTIONS</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_XAML_TYPES</DefineConstants>
    <FeatureXamlTypes>true</FeatureXamlTypes>
    <DefineConstants>$(DefineConstants);FEATURE_XML_SOURCE_URI</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_XML_LOADPATH</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_XML_SCHEMA_VALIDATION</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_XMLTEXTREADER</DefineConstants>
    <DefineConstants>$(DefineConstants);FEATURE_DEBUGGER</DefineConstants>
  </PropertyGroup>
  <PropertyGroup Condition="'$(NetCoreSurface)' == 'true'">

    <!-- Indicates whether CultureInfo has setters for the CurrentCulture and CurrentUICulture properties.
         If not, then the corresponding properties on Thread (which aren't in .NET Core) need to be used. -->
    <DefineConstants>$(DefineConstants);FEATURE_CULTUREINFO_SETTERS</DefineConstants>

    <DefineConstants>$(DefineConstants);FEATURE_PROCESSSTARTINFO_ENVIRONMENT</DefineConstants>
  </PropertyGroup>

  <!-- Change define constants as needed -->
  <PropertyGroup Condition="'$(MsbuildDebugger)' == 'true'">
    <DefineConstants>$(DefineConstants);FEATURE_MSBUILD_DEBUGGER</DefineConstants>
  </PropertyGroup>

  <!-- Setup some common paths -->
  <PropertyGroup>
    <CommonPath>$(SourceDir)Common\src</CommonPath>
    <CommonTestPath>$(SourceDir)Common\tests</CommonTestPath>
  </PropertyGroup>

  <!-- Setup the default output and intermediate paths -->
  <PropertyGroup>
    <BaseOutputPath>$(BinDir)</BaseOutputPath>
    <BaseOutputPathWithConfig>$([System.IO.Path]::Combine($(BaseOutputPath)$(OS),$(Configuration)))$([System.IO.Path]::DirectorySeparatorChar)</BaseOutputPathWithConfig>
    <BaseOutputPathWithConfig Condition="'$(Platform)' != 'AnyCPU'">$([System.IO.Path]::Combine($(BaseOutputPath)$(Platform),$(OS),$(Configuration)))$([System.IO.Path]::DirectorySeparatorChar)</BaseOutputPathWithConfig>
    <OutputPath>$(BaseOutputPathWithConfig)</OutputPath>

    <BaseIntermediateOutputPath>$(BaseOutputPath)obj$([System.IO.Path]::DirectorySeparatorChar)</BaseIntermediateOutputPath>
    <IntermediateOutputPath>$([System.IO.Path]::Combine($(BaseIntermediateOutputPath)$(MSBuildProjectName),$(OS),$(Configuration)))$([System.IO.Path]::DirectorySeparatorChar)</IntermediateOutputPath>
    <IntermediateOutputPath Condition="'$(Platform)' != 'AnyCPU'">$([System.IO.Path]::Combine($(BaseIntermediateOutputPath)$(MSBuildProjectName),$(Platform),$(OS),$(Configuration)))$([System.IO.Path]::DirectorySeparatorChar)</IntermediateOutputPath>

    <TestPath>$(TestWorkingDir)$([System.IO.Path]::Combine($(MSBuildProjectName),$(OS),$(Configuration)))$([System.IO.Path]::DirectorySeparatorChar)</TestPath>
    <TestPath Condition="'$(Platform)' != 'AnyCPU'">$([System.IO.Path]::Combine($(TestWorkingDir)$(MSBuildProjectName),$(Platform),$(OS),$(Configuration)))$([System.IO.Path]::DirectorySeparatorChar)</TestPath>
  </PropertyGroup>



</Project>
